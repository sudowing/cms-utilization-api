# CMS Utilization API

### The purpose of the project is to provide a GraphQL API to multiple data sources related to CMS utilization data.

While there are many benefits of seeding documents into Elastic, I'm doing so to leverage to specific features of Elastic:
- [CMS-Utilization-DB](https://github.com/sudowing/cms-utilization-db)
- [CMS-Utilization-Search](https://github.com/sudowing/cms-utilization-search)
- [NPI Registry](https://npiregistry.cms.hhs.gov/)

__[CMS-Utilization-DB](https://github.com/sudowing/cms-utilization-db)__ is a postgres database that holds millions of records related to healthcare costs and services.

__[CMS-Utilization-Search](https://github.com/sudowing/cms-utilization-search)__ is an ElasticSearch Instance, seeded with records held the [CMS-Utilization-DB](https://github.com/sudowing/cms-utilization-db). This data source powers this APIs autocomplete, suggest and geo search features.

The __[NPI Registry](https://npiregistry.cms.hhs.gov/)__, is a public goverment API that provides access to physicians' registration records. This service has been incorperated because the data held in the [CMS-Utilization-DB]([httdl](https://github.com/sudowing/cms-utilization-db)) is a few years old -- which means that some percentage of records are likely out-of-date. Any where in the client where we want to present the user with contact information -- we should leverage the resources associated with this module.


---

##  <a id="quick-start"></a>Quick Start

```
# starts (and seeds) local postgres & elastic service
make start

# install and run nodejs app (GraphQL API Server)
npm i
npm run start

```

This seeding process will take 45 mins (sample `time` report provided below) to complete on the first run. Subsequent starts rely on persistent data.

    :: real    42m58.263s
    :: user    0m0.884s
    :: sys     0m1.160s


The database & index setup processes are well detailed in their respective repos. If you have any issues, reference their respective readmes.

---

##  <a id="development"></a>Development

The published docker image relies on a compressed file that is generated by:
- seeding ES from the source
- exporting complete indexes using [elasticsearch-dump](https://github.com/taskrabbit/elasticsearch-dump)

To build in indexes manually, generated the index exports and generate the compressed archive needed for the Docker build (`elastic_exports.tar.bz2`) -- follow the steps below.

```
# starts your local cms-utilization-db && elastic service
make run

# seeds index from db via node scripts
make load

# check ES indices are complete
npm run report-index-status

    output
    ----------
    false
    index 'services' short N documents
    index 'providers' short N documents
    index 'providerPerformance' short N documents

```
NOTE: It's very likely that running `make load` one time will not result in a completely built index. You'll need to QA each index individually  using the tools below.

### Seeding Details

Two of these indexes need to hold 1 million+ documents. The process of building out a complete index is pretty painful, but I've provided the tools below to help.

The general seeding process works like this:
- Seed the index making a basic read-all pass over the DB.
- If not complete, populate a temp table in the DB with all the document ids (which are also the table primary keys) that exist in the index.
- seed the index again -- this time only reading the records which **are not** present in the temp table (because they already exist in the index).
- Repeat until index is completely built.

Here are the NPM commands you can run to accomplish what's outlined above:

```
# install dependencies
npm i

# Config all ES Indexes (includes document mapping)
npm run config-services
npm run config-providers
npm run config-provider-performances
# * NOTE: config scripts DELETE exsiting indexes. USE CAUTION.

# Seed Service Records
npm run seed-services
npm run report-index-status
    # while incomplete
    npm run seed-services

# Seed Provider Performance Records
npm run seed-provider-performances
npm run report-index-status
    # while incomplete
    npm run list-provider-performances-ids
    npm run seed-provider-performances-rerun

# Seed Provider (Organization) Records
npm run seed-providers-organizations
npm run report-index-status
    # while incomplete
    npm run list-providers-ids
    npm run seed-providers-organizations-rerun

# Seed Provider (Individual) Records
npm run seed-providers-individuals
npm run report-index-status
    # while incomplete
    npm run list-providers-ids
    npm run seed-providers-individuals-rerun

# drop temp table from DB used to store indexed ids
npm run drop-temp-index-status-table
```



---

##  <a id="api-documentation"></a>API Documentation

The resources in this API are well documented. You can use a variety of methods to interact with this service, but we recomment the following:

- __[GraphQL Playground](http://0.0.0.0:8088/graph/)__ is a postgres database that holds millions of records related to healthcare costs and services. The GraphQL Playground offers and interactive schema inspectors, so for anyone new to the service and the available resources -- this feature could be of some value.

- __[Insomnia API Client](https://insomnia.rest/)__ is an API client that offers great support for building out (and making) GraphQL service calls. The client is very similar to (Postman)[https://www.getpostman.com/], but with better nativ support for GraphQL calls.

- __[Insomnia API Workplace Import](https://insomnia.rest/)__ ...is an ElasticSearch Instance, seeded with records held the [CMS-Utilization-DB]((https://github.com/sudowing/cms-utilization-db)). This data source powers this APIs autocomplete, suggest and geo search features.


---

##  <a id="versioning"></a>Versioning

We use [SemVer](http://semver.org/) for versioning. For the versions available, see the [tags on this repository](https://github.com/sudowing/cms-utilization-db/tags). 

---

##  <a id="license"></a>License

This project is licensed under the MIT License - see the [LICENSE.md](LICENSE.md) file for details